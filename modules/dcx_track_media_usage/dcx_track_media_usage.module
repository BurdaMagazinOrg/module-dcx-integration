<?php

use Drupal\Core\Entity\FieldableEntityInterface;
use Drupal\field\Entity\FieldConfig;

/**
 * Implement hook_entity_insert()-
 */
function dcx_track_media_usage_node_insert($entity) {
  _dcx_track_media_usage_track_media_usage($entity);
}

/**
 * Implement hook_entity_insert()-
 */
function dcx_track_media_usage_node_update($entity) {
  _dcx_track_media_usage_track_media_usage($entity);
}

/**
 * Find media attached to this entity and emmit usage message to DC-X.
 */
function _dcx_track_media_usage_track_media_usage($entity) {
  $discovery = Drupal::service('dcx_track_media_usage.discover_referenced_entities');
  $usage = $discovery->discover($entity);

  $url = $entity->toUrl()->toString();
  $status = $entity->status->value;
  try {
    Drupal::service('dcx_integration.client')->trackUsage($usage, $url, $status);
  } catch (\Exception $e) {
    drupal_set_message($e->getMessage(), 'error');
  }
}



