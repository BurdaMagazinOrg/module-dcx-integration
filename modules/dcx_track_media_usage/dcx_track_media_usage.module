<?php

use Drupal\Core\Entity\FieldableEntityInterface;
use Drupal\field\Entity\FieldConfig;

/*
 * Implement hook_ENTITY_TYPE_delete()-
 */
function dcx_track_media_usage_media_delete($entity) {
  if ('image' !== $entity->bundle()) {
    return;
  }

  $dcx_id = $entity->field_dcx_id->value;
  try {
    $urls = Drupal::service('dcx_integration.client')->removeAllUsage($dcx_id);

    foreach ($urls as $url) {
      $parts = explode('/', $url);
      $entityId = end($parts);
      array_pop($parts);
      $entityType = implode('/', $parts);

      $entityStorage = \Drupal::entityTypeManager()
        ->getStorage($entityType);

      $entityStorage->load($entityId)->save();
    }

  } catch (\Exception $e) {
    drupal_set_message($e->getMessage(), 'error');
  }
}
